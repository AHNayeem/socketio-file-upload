/* Socket IO File Upload Client-Side Library
 *   Copyright (C) 2013 Shane Carr
 *   Released under the X11 License
 * For more information, visit: https://github.com/vote539/socketio-file-upload
 */

window.SocketIOFileUpload=function(k){var h=this;if(!window.File||!window.FileReader)throw Error("Socket.IO File Upload: Browser Not Supported");var f={},m=[],r=[];h.fileInputElementId="siofu_input";h.useText=!1;h.serializedOctets=!1;var q=function(a,b){var c=document.createEvent("Event");c.initEvent(a,!1,!1);for(var e in b)b.hasOwnProperty(e)&&(c[e]=b[e]);return h.dispatchEvent(c)},u=function(a){if(q("start",{file:a})){var b=new FileReader,c=0,e=m.length,f=h.useText,n;m.push(a);b.addEventListener("progress", function(a){});b.addEventListener("load",function(p){a:{p=p.loaded;var m;if(f)m=b.result.slice(c,p);else try{var l=new Uint8Array(b.result,c,p),s;if(h.serializedOctets)s=l;else{var g,t=l.buffer.byteLength,d="";for(g=0;g<t;g+=3)d+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[l[g]>>2],d+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(l[g]&3)<<4|l[g+1]>>4],d+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(l[g+1]&15)<<2|l[g+2]>>6],d+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[l[g+ 2]&63];2===t%3?d=d.substring(0,d.length-1)+"=":1===t%3&&(d=d.substring(0,d.length-2)+"==");s=d}m=s}catch(r){k.emit("siofu_done",{id:e,interrupt:!0});break a}k.emit("siofu_progress",{id:e,start:c,end:p,content:m,base64:!h.serializedOctets});c=p}k.emit("siofu_done",{id:e});q("load",{file:a,reader:b,name:n})});b.addEventListener("error",function(){k.emit("siofu_done",{id:e,interrupt:!0})});b.addEventListener("abort",function(){k.emit("siofu_done",{id:e,interrupt:!0})});k.emit("siofu_start",{name:a.name, mtime:a.lastModifiedDate,encoding:f?"text":"octet",id:e});r.push(f?function(c){b.readAsText(a);n=c}:function(c){b.readAsArrayBuffer(a);n=c})}},n=function(a){var b=a.target.files||a.dataTransfer.files;a.preventDefault();if(0<b.length&&q("choose",{files:b}))for(a=0;a<b.length;a++)u(b[a])};this.listenOnInput=function(a){a.files&&a.addEventListener("change",n,!1)};this.listenOnDrop=function(a){a.addEventListener("dragover",function(a){a.preventDefault()},!1);a.addEventListener("drop",n)};this.prompt= function(){var a;a=document.getElementById(h.fileInputElementId);a||(a=document.createElement("input"),a.setAttribute("type","file"),a.setAttribute("id",h.fileInputElementId),a.style.display="none",document.body.appendChild(a));a.addEventListener("change",n,!1);var b=document.createEvent("MouseEvents");b.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null);a.dispatchEvent(b)};this.addEventListener=function(a,b){f[a]||(f[a]=[]);f[a].push(b)};this.removeEventListener=function(a,b){if(!f[a])return!1; for(var c=0;c<f[a].length;c++)if(f[a][c]===b)return f[a].splice(c,1),!0;return!1};this.dispatchEvent=function(a){var b=f[a.type];if(!b)return!0;for(var c=!0,e=0;e<b.length;e++)!1===b[e](a)&&(c=!1);return c};k.on("siofu_ready",function(a){r[a.id](a.name)});k.on("siofu_complete",function(a){q("complete",{file:m[a.id],success:a.success})})};
