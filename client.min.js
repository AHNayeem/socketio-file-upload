/* Socket IO File Upload Client-Side Library
 *   Copyright (C) 2015 Shane Carr and others
 *   Released under the X11 License
 * For more information, visit: https://github.com/vote539/socketio-file-upload
 */

(function(g,d,f){"function"===typeof define&&define.amd?define(d,f):"object"===typeof module&&module.exports?module.exports=f():g[d]=f()})(this,"SocketIOFileUpload",function(){return function(g){var d=this;if(!window.File||!window.FileReader)throw Error("Socket.IO File Upload: Browser Not Supported");var f={},p=[],t=[];d.fileInputElementId="siofu_input";d.resetFileInputs=!0;d.useText=!1;d.serializedOctets=!1;d.useBuffer=!0;d.chunkSize=102400;var q=function(a,b){var c=document.createEvent("Event");
c.initEvent(a,!1,!1);for(var x in b)b.hasOwnProperty(x)&&(c[x]=b[x]);return d.dispatchEvent(c)},n=[],e=function(a,b,c,d){a.addEventListener(b,c,d);n.push(arguments)},r=function(a,b,c,d){a.removeEventListener&&a.removeEventListener(b,c,d)},y=function(){for(var a=n.length-1;0<=a;a--)r.apply(this,n[a]);n=[]},z=function(a){if(null!==d.maxFileSize&&a.size>d.maxFileSize)q("error",{file:a,message:"Attempt by client to upload file exceeding the maximum file size",code:1});else if(q("start",{file:a})){var b=
new FileReader,c=p.length,f=d.useText,u=0,n;b._realReader&&(b=b._realReader);p.push(a);var v=d.chunkSize;if(v>=a.size||0>=v)v=a.size;var w=function(){var c=a.slice(u,Math.min(u+v,a.size));f?b.readAsText(c):b.readAsArrayBuffer(c)},k=function(e){var k=Math.min(u+v,a.size);a:{var p=u;e=e.target.result;var t=!1;if(!f)try{var l=new Uint8Array(e);if(d.serializedOctets)e=l;else if(d.useBuffer)e=l.buffer;else{var t=!0,m,r=l.buffer.byteLength,h="";for(m=0;m<r;m+=3)h+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[l[m]>>
2],h+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(l[m]&3)<<4|l[m+1]>>4],h+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(l[m+1]&15)<<2|l[m+2]>>6],h+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[l[m+2]&63];2===r%3?h=h.substring(0,h.length-1)+"=":1===r%3&&(h=h.substring(0,h.length-2)+"==");e=h}}catch(y){g.emit("siofu_done",{id:c,interrupt:!0});break a}g.emit("siofu_progress",{id:c,size:a.size,start:p,end:k,content:e,base64:t})}q("progress",
{file:a,bytesLoaded:k,name:n});u+=v;u<a.size?w():(g.emit("siofu_done",{id:c}),q("load",{file:a,reader:b,name:n}))};e(b,"load",k);e(b,"error",function(){g.emit("siofu_done",{id:c,interrupt:!0});r(b,"load",k)});e(b,"abort",function(){g.emit("siofu_done",{id:c,interrupt:!0});r(b,"load",k)});g.emit("siofu_start",{name:a.name,mtime:a.lastModifiedDate,meta:a.meta,size:a.size,encoding:f?"text":"octet",id:c});t.push(function(a){n=a;w()})}},w=function(a){if(0!==a.length){for(var b=0;b<a.length;b++)a[b].meta||
(a[b].meta={});if(q("choose",{files:a}))for(b=0;b<a.length;b++)z(a[b])}},k=function(a){var b=a.target.files||a.dataTransfer.files;a.preventDefault();w(b);if(d.resetFileInputs){try{a.target.value=""}catch(e){}if(a.target.value){var b=document.createElement("form"),c=a.target.parentNode,f=a.target.nextSibling;b.appendChild(a.target);b.reset();c.insertBefore(a.target,f)}}};this.submitFiles=function(a){a&&w(a)};this.listenOnSubmit=function(a,b){b.files&&e(a,"click",function(){w(b.files)},!1)};this.listenOnArraySubmit=
function(a,b){for(var c in b)this.listenOnSubmit(a,b[c])};this.listenOnInput=function(a){a.files&&e(a,"change",k,!1)};this.listenOnDrop=function(a){e(a,"dragover",function(a){a.preventDefault()},!1);e(a,"drop",k)};this.prompt=function(){var a;a=document.getElementById(d.fileInputElementId);a||(a=document.createElement("input"),a.setAttribute("type","file"),a.setAttribute("id",d.fileInputElementId),a.style.display="none",document.body.appendChild(a));e(a,"change",k,!1);var b=document.createEvent("MouseEvents");
b.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null);a.dispatchEvent(b)};this.destroy=function(){y();var a=document.getElementById(d.fileInputElementId);a&&a.parentNode.removeChild(a);f={};p=[];t=[]};this.addEventListener=function(a,b){f[a]||(f[a]=[]);f[a].push(b)};this.removeEventListener=function(a,b){if(!f[a])return!1;for(var c=0;c<f[a].length;c++)if(f[a][c]===b)return f[a].splice(c,1),!0;return!1};this.dispatchEvent=function(a){var b=f[a.type];if(!b)return!0;for(var c=!0,d=0;d<
b.length;d++)!1===b[d](a)&&(c=!1);return c};e(g,"siofu_ready",function(a){t[a.id](a.name)});e(g,"siofu_complete",function(a){q("complete",{file:p[a.id],detail:a.detail,success:a.success})});e(g,"siofu_error",function(a){q("error",{file:p[a.id],message:a.message,code:0})})}});
